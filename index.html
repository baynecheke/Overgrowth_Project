


import React, { useEffect, useState } from 'react';

// Overgrowth — Single-file React app
// Simplified: Single-player vs AI, Pokémon-style layout, one action per turn (your Primary),
// step-by-step instruction bar, 6s loading screen, no drafting/login/multiplayer.

// --- Sample card pool ---
const SAMPLE_CARDS = [
  { id: 'S1', name: 'Moonvine', type: 'Nocturnal', energy: 2, hp: 30, atk: 12, passive: 'Night Surge' },
  { id: 'S2', name: 'Shroomguard', type: 'Fungal',    energy: 3, hp: 40, atk: 8,  passive: 'Tough Spores' },
  { id: 'S3', name: 'Brambleback', type: 'Thorn',     energy: 2, hp: 50, atk: 10, passive: 'Thorny' },
  { id: 'S4', name: 'Riverling',   type: 'Water',     energy: 2, hp: 28, atk: 14, passive: 'Hydrated' },
  { id: 'S5', name: 'Sunpetal',    type: 'Sun',       energy: 2, hp: 26, atk: 13, passive: 'Photosynth' },
  { id: 'S6', name: 'Rootkin',     type: 'Normal',    energy: 1, hp: 22, atk: 9,  passive: 'Versatile' },
];

const TYPE_ORDER = ['Nocturnal', 'Fungal', 'Normal', 'Thorn', 'Water', 'Sun'];

function uid(prefix = 'id') { return prefix + '_' + Math.random().toString(36).slice(2,9); }
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function makeCardRuntime(c){ return ({...c, uid: uid('card'), currentHP: c.hp, maxHP: c.hp, energyCur: c.energy, exhausted:false, atkMod:0}); }
function buildDeck(){
  const pool = [];
  for(let r=0;r<3;r++) for(const c of SAMPLE_CARDS) pool.push({...c});
  return shuffle(pool).map(makeCardRuntime);
}
function typeHasAdvantage(att, def){ const a = TYPE_ORDER.indexOf(att); const d = TYPE_ORDER.indexOf(def); return (a + TYPE_ORDER.length - d) % TYPE_ORDER.length === 1; }

// Inject CSS (single-file; no external CSS)
function injectCSS(){ if(typeof document==='undefined') return; const id='og-styles'; if(document.getElementById(id)) return; const css=`
:root{ --bg:#071024; --panel:rgba(255,255,255,0.06); --muted:#94a3b8; --accent1:#34d399; --accent2:#60a5fa; }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:radial-gradient(1000px 500px at 10% -20%, #0b1b3a, transparent), linear-gradient(180deg,#071024,#0f172a);color:#e6eef8}
.wrap{max-width:1200px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:800;font-size:28px;background:linear-gradient(90deg,#bbf7d0,#60a5fa);-webkit-background-clip:text;color:transparent}
.subtitle{color:var(--muted);font-size:13px}
.playmat{margin-top:14px;display:grid;grid-template-columns:1fr 360px;gap:14px}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06)}
.leftcol{display:flex;flex-direction:column;gap:12px}
.mat{padding:14px;border-radius:12px}
.row{display:flex;justify-content:center;align-items:center;gap:12px}
.active-slot{width:260px;height:160px}
.bench-slot{width:140px;height:110px}
.card-visual{width:100%;height:100%;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;border:1px solid rgba(255,255,255,0.08);cursor:pointer;background:rgba(2,6,23,0.5)}
.card-visual.disabled{opacity:0.45;cursor:default}
.sidepanel{width:340px;display:flex;flex-direction:column;gap:10px}
.btn{padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;border:none}
.btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#05264b}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.14)}
.btn-danger{background:linear-gradient(90deg,#fb7185,#f97316);color:#140808}
.log{max-height:220px;overflow:auto;padding:8px;background:rgba(0,0,0,0.18);border-radius:10px}
.select-highlight{outline:3px solid rgba(96,165,250,0.22);box-shadow:0 6px 18px rgba(96,165,250,0.06)}
.center{display:flex;align-items:center;justify-content:center}
.loading{height:60vh}
.instruction{display:flex;gap:10px;align-items:center}
.badge{font-size:11px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.16)}
.hr{height:10px}
`;
 const s=document.createElement('style'); s.id=id; s.appendChild(document.createTextNode(css)); document.head.appendChild(s); }

// Simple hand-made SVG type art
function TypeArt({type}){
  const commonStyle={width:'100%',height:'100%'};
  if(type==='Sun') return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="gSun" x1="0" x2="1"><stop offset="0" stopColor="#fffbeb"/><stop offset="1" stopColor="#f59e0b"/></linearGradient></defs>
      <rect width="100%" height="100%" fill="#fffbeb" opacity="0.04"/>
      <g transform="translate(100,60)">
        <circle r="30" fill="url(#gSun)" stroke="#f97316" strokeWidth="3" />
        <g stroke="#f97316" strokeWidth="3">
          <line x1="-50" y1="0" x2="-20" y2="0" />
          <line x1="50" y1="0" x2="20" y2="0" />
          <line x1="0" y1="-40" x2="0" y2="-20" />
          <line x1="0" y1="40" x2="0" y2="20" />
        </g>
      </g>
    </svg>
  );
  if(type==='Water') return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#eff6ff" opacity="0.03"/>
      <g transform="translate(100,60)">
        <path d="M0 -40 C 28 -20, 28 10, 0 40 C -28 10, -28 -20, 0 -40 Z" fill="#60a5fa" stroke="#1e40af" strokeWidth="2"/>
        <circle cx="6" cy="-6" r="3" fill="#bfdbfe" />
      </g>
    </svg>
  );
  if(type==='Thorn') return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#ecfdf5" opacity="0.02"/>
      <g transform="translate(100,60)">
        <path d="M-30 20 C -10 -20, 10 -20, 30 20 L 20 22 C 0 -6, -0 -6, -20 22 Z" fill="#4ade80" stroke="#166534" strokeWidth="2"/>
        <line x1="-10" y1="-6" x2="-12" y2="-18" stroke="#166534" strokeWidth="2"/>
        <line x1="10" y1="-6" x2="12" y2="-18" stroke="#166534" strokeWidth="2"/>
      </g>
    </svg>
  );
  if(type==='Fungal') return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#fff7ed" opacity="0.02"/>
      <g transform="translate(100,60)">
        <ellipse rx="34" ry="18" fill="#fb7185" stroke="#7f1d1d"/>
        <rect x="-10" y="-2" width="20" height="36" rx="6" fill="#a16207" />
        <circle cx="-10" cy="-6" r="3" fill="#fecaca" />
        <circle cx="4" cy="-10" r="2.5" fill="#fecaca" />
      </g>
    </svg>
  );
  if(type==='Normal') return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#f0fdf4" opacity="0.02"/>
      <g transform="translate(100,60)">
        <path d="M-30 6 C -10 -26, 10 -26, 30 6 C 10 18, -10 18, -30 6 Z" fill="#86efac" stroke="#14532d" strokeWidth="1.5"/>
        <line x1="-8" y1="-6" x2="8" y2="6" stroke="#14532d" strokeWidth="1"/>
      </g>
    </svg>
  );
  // Nocturnal
  return (
    <svg viewBox="0 0 200 140" style={commonStyle} xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="#f5f3ff" opacity="0.02"/>
      <g transform="translate(100,60)">
        <circle r="20" fill="#a78bfa" />
        <path d="M-36 -12 C -16 2, -6 10, 6 24 C 18 10, 28 2, 36 -12" stroke="#7c3aed" strokeWidth="2" fill="none" />
      </g>
    </svg>
  );
}

// Card visual component
function CardVisual({card, className, onClick}){
  const disabled = !card || (card && card.currentHP <=0);
  return (
    <div className={`card-visual ${disabled? 'disabled':''} ${className||''}`} onClick={disabled?undefined:() => onClick && onClick(card)}>
      <div style={{height:100, background:'#071a2b'}}>
        {card ? <TypeArt type={card.type} /> : null}
      </div>
      <div style={{padding:8, display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}}>
        <div>
          <div style={{fontWeight:800}}>{card ? card.name : '—'}</div>
          <div style={{fontSize:12,color:'var(--muted)'}}>{card ? `${card.type} • EN ${card.energyCur}` : ''}</div>
        </div>
        {card && (
          <div style={{textAlign:'right'}}>
            <div style={{fontWeight:800}}>{card.currentHP}</div>
            <div style={{fontSize:12,color:'var(--muted)'}}>HP</div>
          </div>
        )}
      </div>
    </div>
  );
}

export default function App(){
  injectCSS();

  // 6s loading screen
  const [loading, setLoading] = useState(true);
  useEffect(()=>{ const t = setTimeout(()=> setLoading(false), 6000); return ()=> clearTimeout(t); },[]);

  // phases: 'menu' | 'battle' | 'result'
  const [phase, setPhase] = useState('menu');

  // game state
  const [combat,setCombat] = useState(null); // { setups:[{primary, bench:[]},{primary, bench:[]}], turn:0 }
  const [selected, setSelected] = useState(null); // {player:0, slot:'primary'}
  const [mode, setMode] = useState(null); // 'attack' | 'support' | null
  const [log,setLog] = useState([]);

  const appendLog = (m)=> setLog(l=>[m,...l].slice(0,120));

  // Utilities
  function checkVictory(state){
    const empty = (s)=> !s.primary && (!s.bench || s.bench.length===0);
    const a = empty(state.setups[0]);
    const b = empty(state.setups[1]);
    if(a && b) return 'Draw';
    if(b) return 'You Win!';
    if(a) return 'You Lose';
    return null;
  }

  function supportEffect(sourceType, target){
    if(!target) return 'No target';
    if(sourceType==='Sun'){ const heal=6; target.currentHP = Math.min(target.currentHP + heal, target.maxHP); return `Healed ${heal} HP`; }
    if(sourceType==='Water'){ target.energyCur = (target.energyCur||0)+1; return 'Gave +1 energy'; }
    if(sourceType==='Thorn'){ target.atkMod = (target.atkMod||0)+2; return 'Granted +2 ATK'; }
    if(sourceType==='Fungal'){ const heal=3; target.currentHP = Math.min(target.currentHP + heal, target.maxHP); target.energyCur=(target.energyCur||0)+1; return 'Healed 3 HP and +1 energy'; }
    if(sourceType==='Normal'){ target.atkMod = (target.atkMod||0)+3; return 'Granted +3 ATK'; }
    target.atkMod = (target.atkMod||0)+2; target.energyCur=(target.energyCur||0)+1; return 'Night boost: +2 ATK +1 energy';
  }

  // Start a battle with pre-selected teams (no drafting)
  function startBattle(){
    const deck = buildDeck();
    const yourTeam = [deck[0], deck[1], deck[2]];
    const aiTeam   = [deck[3], deck[4], deck[5]];
    const setups = [
      { primary: makeCardRuntime(yourTeam[0]), bench: [makeCardRuntime(yourTeam[1]), makeCardRuntime(yourTeam[2])] },
      { primary: makeCardRuntime(aiTeam[0]),   bench: [makeCardRuntime(aiTeam[1]),   makeCardRuntime(aiTeam[2])] }
    ];
    setCombat({setups, turn:0});
    setPhase('battle');
    setSelected(null); setMode(null); setLog([]);
    appendLog('Battle started! Click your Primary to act.');
  }

  // perform attack from source to target
  const executeAttack = (sourcePlayer, sourceSlot, targetPlayer, targetSlot)=>{
    if(!combat) return;
    const s = JSON.parse(JSON.stringify(combat));
    const actor = s.setups[sourcePlayer][sourceSlot];
    const target = s.setups[targetPlayer][targetSlot];
    if(!actor || !target) { appendLog('Invalid attack'); return; }
    if(actor.exhausted || actor.energyCur<1) { appendLog('Actor cannot act'); return; }
    actor.energyCur -= 1; if(actor.energyCur<=0) actor.exhausted = true;
    const baseAtk = actor.atk + (actor.atkMod||0);
    let dmg = baseAtk + (typeHasAdvantage(actor.type, target.type)?10:0);
    target.currentHP -= dmg;
    appendLog(`${actor.name} attacked ${target.name} for ${dmg} damage`);
    if(target.currentHP<=0){
      appendLog(`${target.name} was defeated`);
      if(targetSlot==='primary'){
        s.setups[targetPlayer].primary = s.setups[targetPlayer].bench.shift()||null;
      } else {
        s.setups[targetPlayer][targetSlot]=null;
      }
    }
    setCombat(s);
    const res = checkVictory(s); if(res){ setPhase('result'); appendLog('Result: '+res); return; }
    setSelected(null); setMode(null);
    if(sourcePlayer===0) setTimeout(()=> aiTakeTurn(), 480);
  };

  // execute support action: source helps ally target
  const executeSupport = (sourcePlayer, sourceSlot, targetPlayer, targetSlot)=>{
    if(!combat) return;
    const s = JSON.parse(JSON.stringify(combat));
    const actor = s.setups[sourcePlayer][sourceSlot];
    const target = s.setups[targetPlayer][targetSlot];
    if(!actor || !target){ appendLog('Invalid support'); return; }
    if(actor.exhausted || actor.energyCur<1){ appendLog('Actor cannot act'); return; }
    actor.energyCur -= 1; if(actor.energyCur<=0) actor.exhausted=true;
    const desc = supportEffect(actor.type, target);
    appendLog(`${actor.name} supported ${target.name}: ${desc}`);
    setCombat(s);
    setSelected(null); setMode(null);
    if(sourcePlayer===0) setTimeout(()=> aiTakeTurn(), 480);
  };

  // AI turn: only AI primary acts
  function aiTakeTurn(){
    if(!combat) return;
    const s = combat;
    const ai = s.setups[1];
    const me = s.setups[0];
    const actor = ai.primary;
    if(!actor || actor.exhausted || actor.energyCur<1){ appendLog('AI has no available actions'); return; }
    // simple logic: heal/support if low HP, else attack
    const doSupport = actor.currentHP < actor.maxHP/2 && Math.random()<0.45;
    if(doSupport){ executeSupport(1, 'primary', 1, 'primary'); return; }
    const targetSlot = me.primary? 'primary' : null; if(targetSlot){ executeAttack(1, 'primary', 0, targetSlot); }
  }

  // Selection handlers — only your Primary can act
  function onSelectPrimary(){ if(!combat) return; const card = combat.setups[0].primary; if(!card) return; if(card.exhausted||card.energyCur<1){ appendLog('Primary cannot act'); return; } setSelected({player:0, slot:'primary'}); setMode(null); }
  function onClickEnemy(slot){ if(!selected || !mode) return; if(mode!=='attack') { appendLog('Tap Attack, then choose target'); return; } executeAttack(selected.player, selected.slot, 1, slot); }
  function onClickAlly(slot){ if(!selected || !mode) return; if(mode!=='support'){ appendLog('Tap Support, then choose ally'); return; } executeSupport(selected.player, selected.slot, 0, slot); }

  // Instruction bar (contextual)
  function instructionText(){
    if(phase==='menu') return 'Press Start Battle to jump in. No drafting — we pick teams for you!';
    if(phase==='result') return 'Match complete. Press Restart to play again.';
    if(!combat) return 'Loading battle...';
    const you = combat.setups[0];
    if(!selected) return 'Your turn: Click your Primary card (bottom center) to act.';
    if(selected && !mode) return 'Choose an action: Attack (damage enemy) or Support (help an ally).';
    if(mode==='attack') return 'Target: Click the enemy Primary (top center).';
    if(mode==='support') return 'Target: Click your Primary to receive the support.';
    return 'Your move!';
  }

  // Loading screen
  if(loading){
    return (
      <div className="wrap center loading">
        <div className="panel" style={{padding:24,textAlign:'center',minWidth:340}}>
          <div className="title">Overgrowth</div>
          <div className="subtitle" style={{marginTop:4}}>Growing the garden...</div>
          <div style={{marginTop:16,height:8,background:'rgba(255,255,255,0.12)',borderRadius:999}}>
            <div style={{height:8,width:'40%',background:'linear-gradient(90deg,var(--accent1),var(--accent2))',borderRadius:999,animation:'grow 1.2s infinite alternate'}} />
          </div>
          <style>{`@keyframes grow{from{width:20%}to{width:90%}}`}</style>
        </div>
      </div>
    );
  }

  // Menu screen
  if(phase==='menu'){
    return (
      <div className="wrap">
        <div className="header">
          <div>
            <div className="title">Overgrowth</div>
            <div className="subtitle">Single-player • Pokémon-style board • One action per turn</div>
          </div>
          <button className="btn btn-primary" onClick={startBattle}>Start Battle</button>
        </div>
        <div className="panel" style={{marginTop:14}}>
          <div className="instruction"><span className="badge">Tutorial</span> {instructionText()}</div>
        </div>
        <div className="panel" style={{marginTop:12}}>
          <div style={{fontWeight:700}}>How to play</div>
          <ul style={{marginTop:8,lineHeight:1.6,color:'var(--muted)'}}>
            <li>Click <b>Start Battle</b>. You and the AI each have 3 plants.</li>
            <li>Your <b>Primary</b> (bottom center) is the only plant that acts each turn.</li>
            <li>Click your Primary → choose <b>Attack</b> (deal damage) or <b>Support</b> (buff/heal).</li>
            <li>Then click the target prompt that appears in the side panel.</li>
            <li>When a plant is defeated, the next bench plant moves up automatically.</li>
            <li>First side to lose all plants loses the match.</li>
          </ul>
        </div>
      </div>
    );
  }

  // Result screen
  if(phase==='result'){
    const outcome = checkVictory(combat) || 'Match Over';
    return (
      <div className="wrap">
        <div className="header">
          <div className="title">Overgrowth</div>
          <div className="subtitle">{outcome}</div>
          <div />
        </div>
        <div className="panel" style={{marginTop:14}}>
          <div className="instruction"><span className="badge">Result</span> {outcome}</div>
        </div>
        <div className="panel" style={{marginTop:12,display:'flex',gap:8}}>
          <button className="btn btn-primary" onClick={startBattle}>Restart</button>
          <button className="btn btn-ghost" onClick={()=>{ setPhase('menu'); setCombat(null); setSelected(null); setMode(null); setLog([]); }}>Back to Menu</button>
        </div>
        <div className="panel" style={{marginTop:12}}>
          <div style={{fontWeight:700, marginBottom:6}}>Battle Log</div>
          <div className="log">{log.length? log.map((m,i)=> (<div key={i} style={{fontSize:13,opacity:0.9,marginBottom:4}}>{m}</div>)) : <div style={{color:'var(--muted)'}}>No events</div>}</div>
        </div>
      </div>
    );
  }

  // Battle screen
  return (
    <div className="wrap">
      <div className="header">
        <div>
          <div className="title">Overgrowth</div>
          <div className="subtitle">Single-player • One action per turn</div>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button className="btn btn-ghost" onClick={()=> setPhase('menu')}>Quit</button>
          <button className="btn btn-primary" onClick={startBattle}>Restart</button>
        </div>
      </div>

      <div className="panel" style={{marginTop:10}}>
        <div className="instruction"><span className="badge">Step</span> {instructionText()}</div>
      </div>

      <div className="playmat">
        <div className="leftcol">
          <div className="panel mat">
            {/* Opponent row (AI) */}
            <div className="row">
              <div className="active-slot">
                <CardVisual card={combat?.setups?.[1]?.primary||null} onClick={()=>{}} />
              </div>
            </div>
            <div className="row">
              {Array.from({length:3}).map((_,i)=> (
                <div key={i} className="bench-slot">
                  <CardVisual card={combat?.setups?.[1]?.bench?.[i]||null} onClick={()=>{}} />
                </div>
              ))}
            </div>

            <div className="hr" />

            {/* Player row */}
            <div className="row">
              <div className={`active-slot ${selected?.player===0 && selected?.slot==='primary' ? 'select-highlight':''}`} onClick={onSelectPrimary}>
                <CardVisual card={combat?.setups?.[0]?.primary||null} onClick={onSelectPrimary} />
              </div>
            </div>
            <div className="row">
              {Array.from({length:3}).map((_,i)=> (
                <div key={i} className="bench-slot">
                  <CardVisual card={combat?.setups?.[0]?.bench?.[i]||null} onClick={()=>{}} />
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="panel sidepanel">
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{fontWeight:800}}>Actions</div>
            <div style={{color:'var(--muted)'}}>{selected? `Selected: Primary` : 'No selection'}</div>
          </div>

          <div style={{display:'flex',gap:8,marginTop:8}}>
            <button className="btn btn-primary" onClick={()=> setMode('attack')} disabled={!combat || !combat.setups?.[0]?.primary}>Attack</button>
            <button className="btn btn-primary" onClick={()=> setMode('support')} disabled={!combat || !combat.setups?.[0]?.primary}>Support</button>
            <button className="btn btn-ghost" onClick={()=>{ setSelected(null); setMode(null); }}>Clear</button>
          </div>
          <div style={{marginTop:8,color:'var(--muted)'}}>Mode: {mode||'None'}</div>

          <div className="hr" />

          <div>
            <div style={{fontWeight:700}}>Targets</div>
            <div style={{display:'flex',flexDirection:'column',marginTop:8,gap:6}}>
              <div style={{fontSize:13,color:'var(--muted)'}}>For Attack: click enemy Primary. For Support: click your Primary.</div>
              <div className="btn btn-ghost" style={{textAlign:'center'}} onClick={()=> onClickEnemy('primary')}>
                Enemy Primary: {combat?.setups?.[1]?.primary? combat.setups[1].primary.name : '—'}
              </div>
              <div className="btn btn-ghost" style={{textAlign:'center'}} onClick={()=> onClickAlly('primary')}>
                Your Primary: {combat?.setups?.[0]?.primary? combat.setups[0].primary.name : '—'}
              </div>
            </div>
          </div>

          <div className="hr" />

          <div>
            <div style={{fontWeight:700}}>Battle Log</div>
            <div className="log">{log.length? log.map((m,i)=> (<div key={i} style={{fontSize:13,opacity:0.9,marginBottom:4}}>{m}</div>)) : <div style={{color:'var(--muted)'}}>No events yet</div>}</div>
          </div>
        </div>
      </div>

      <div style={{textAlign:'center',marginTop:12,color:'var(--muted)'}}>Hand-made SVG cards • Pokémon-style board • AI opponent • Tutorial steps above</div>
    </div>
  );
}
